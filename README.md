<!-- This is one of the ugliest pieces of code I have ever written. -->